## ì˜ì¡´ì„± ì—­ì „

```
buckpal
â””â”€â”€ account
    â”œâ”€â”€ adapter
    â”‚   â””â”€â”€ out
    â”‚        â””â”€â”€ persistence
    â”‚           â”œâ”€â”€ AccountPersistenceAdapter
    â”‚           â””â”€â”€ SpringDataAccountRepository
    â””â”€â”€ application
        â””â”€â”€ SendMoneyService
        â””â”€â”€ port
             â””â”€â”€ out
                  â””â”€â”€ LoadAccountPort
                  â””â”€â”€ UpdateAccountStatePort
```



[ì„œë¹„ìŠ¤] -> [í¬íŠ¸] <- [ì˜ì†ì„± ì–´ëŒ‘í„°]

- ì„œë¹„ìŠ¤ì—ì„œëŠ” ì˜ì†ì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í¬íŠ¸ ì¸í„°í˜ì´ìŠ¤ë¥¼ í˜¸ì¶œ
- í¬íŠ¸ëŠ” ë°ì˜ì†ì„± ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì™€ í†µì‹ í•  ì±…ì„ì„ ê°€ì§„ ì˜ì†ì„± ì–´ëŒ‘í„° í´ë˜ìŠ¤ì— ì˜í•´ êµ¬í˜„ë¨
- ì˜ì†ì„± ì–´ëŒ‘í„° -> ì•„ì›ƒê³ ì‰ ì–´ëŒ‘í„°
  - ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì˜í•´ í˜¸ì¶œë  ë¿, ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í˜¸ì¶œí•˜ì§€ëŠ” ì•ŠìŒ
- í¬íŠ¸ -> ì„œë¹„ìŠ¤ì™€ ì˜ì†ì„± ì½”ë“¯ ã…ì´ì˜ ê°„ì ‘ì  ê³„ì¸µ

- ì˜ì¡´ì„±ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ì–´ì—ì„œ ì˜ì†ì„± ì–´ëŒ‘í„°ë¡œ í–¥í•¨



## ì˜ì†ì„± ì–´ëŒ‘í„°ì˜ ì±…ì„

- ì˜ì†ì„± ì–´ëŒ‘í„°ê°€ í•˜ëŠ” ì¼
  1. ì…ë ¥ì„ ë°›ìŒ
  2. ì…ë ¥ì„ ë°ì´í„°ë² ì´ìŠ¤ í¬ë§·ìœ¼ë¡œ ë§¤í•‘
  3. ì…ë ¥ì„ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ë³´ëƒ„
  4. ë°ì´í„°ë² ì´ìŠ¤ ì¶œë ¥ì„ ì• í”Œë¦¬ì¼€ì´ì…˜ í¬ë§·ìœ¼ë¡œ ë§¤í•‘
  5. ì¶œë ¥ì„ ë°˜í™˜



### 1. ì…ë ¥ì„ ë°›ìŒ

- í¬íŠ¸ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ì…ë ¥ì„ ë°›ìŒ

- ì…ë ¥ ëª¨ë¸ì€ ì¸í„°í˜ì´ìŠ¤ê°€ ì§€ì •í•œ ë„ë©”ì¸ ì—”í‹°í‹°ë‚˜ íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ ì—°ì‚° ì „ìš© ê°ì²´ê°€ ë¨

  

### 2. ì…ë ¥ì„ ë°ì´í„°ë² ì´ìŠ¤ í¬ë§·ìœ¼ë¡œ ë§¤í•‘

- ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¿¼ë¦¬í•˜ê±°ë‚˜ ë³€ê²½í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í¬ë§·ìœ¼ë¡œ ì…ë ¥ ëª¨ë¸ì„ ë§¤í•‘	
  - ì£¼ë¡œ JPA ì—”í‹°í‹° ê°ì²´ë¡œ ë§¤í•‘...

- ì˜ì†ì„± ì–´ëŒ‘í„°ì˜ ì…ë ¥ ëª¨ë¸ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ì–´ì— ìˆê¸° ë–„ë¬¸ì— ì˜ì†ì„± ì–´ëŒ‘í„° ë‚´ë¶€ë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒì´ ì½”ì–´ì— ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•Šì„ ê²ƒ

  

### 3. ì…ë ¥ì„ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ë³´ë‚´ê³  ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ë°›ì•„ì˜´

### 4. ë°ì´í„°ë² ì´ìŠ¤ ì‘ë‹µì„ í¬íŠ¸ì— ì •ì˜ëœ ì¶œë ¥ ëª¨ë¸ë¡œ ë§¤í•‘

### 5. ë°˜í™˜



## í¬íŠ¸ ì¸í„°í˜ì´ìŠ¤ ë‚˜ëˆ„ê¸°

- íŠ¹ì • ì—”í‹°í‹°ê°€ í•„ìš”ë¡œ í•˜ëŠ” **ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ì—°ì‚°ì„ í•˜ë‚˜ì˜ ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ì— ë„£ì–´ë‘ëŠ” ê²Œ** ì¼ë°˜ì ì¸ ë°©ë²•ì´ì˜€ìŒ
  - ë°ì´í„°ë² ì´ìŠ¤ ì—°ì‚°ì— ì˜ì¡´í•˜ëŠ” ê° ì„œë¹„ìŠ¤ëŠ” ì¸í„°í˜ì´ìŠ¤ì—ì„œ ë‹¨ í•˜ë‚˜ì˜ ë©”ì„œë“œë§Œ ì‚¬ìš©í•˜ë”ë¼ë„ **í•˜ë‚˜ì˜ ë„“ì€ í¬íŠ¸ ì¸í„°í˜ì´ìŠ¤**ì— ì˜ì¡´ì„±ì„ ê°–ê²Œ ë¨ -> ë¶ˆí•„ìš”í•œ ì˜ì¡´ì„± ìƒì„±
- ì¸í„°í˜ì´ìŠ¤ ë¶„ë¦¬ì˜ ì›ì¹™ : í´ë¼ì´ì–¸íŠ¸ê°€ ì˜¤ë¡œì§€ ìì‹ ì´ í•„ìš”ë¡œ í•˜ëŠ” ë©”ì„œë“œë§Œ ì•Œë©´ ë˜ë„ë¡ ë„“ì€ ì¸í„°í˜ì´ìŠ¤ë¥¼ íŠ¹í™”ëœ ì¸í„°í˜ì´ìŠ¤ë¡œ ë¶„ë¦¬í•´ì•¼ í•¨



### ì•„ì›ƒê³ ì‰ í¬íŠ¸ì— ì ìš©

[ì„œë¹„ìŠ¤] -> [í¬íŠ¸] <- [ì˜ì†ì„±ì–´ëŒ‘í„°]

- application.service
  - SendMoneyService
  - RegisterAccountService
- application.port.out
  - LoadAccountPort
  - UpdateAccountStatePort
  - CreateAccountPort
- adapter.out.persistence
  - ì˜ì†ì„± ì–´ëŒ‘í„°



## ì˜ì†ì„± ì–´ëŒ‘í„° ë‚˜ëˆ„ê¸°

- ì˜ì†ì„± ì—°ì‚°ì´ í•„ìš”í•œ ë„ë©”ì¸ í´ë˜ìŠ¤(ë˜ëŠ” ì• ê·¸ë¦¬ê±°íŠ¸) í•˜ë‚˜ë‹¹ í•˜ë‚˜ì˜ ì˜ì†ì„± ì–´ëŒ‘í„°ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìŒ
- **í•˜ë‚˜ì˜ ì• ê·¸ë¦¬ê±°íŠ¸ë‹¹ í•˜ë‚˜ì˜ ì˜ì†ì„± ì–´ëŒ‘í„°**ë¥¼ ë§Œë“¤ì–´ì„œ ì—¬ëŸ¬ ê°œì˜ ì˜ì†ì„± ì–´ëŒ‘í„°ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŒ
  - application.service
    - SendMoneyService
    - RegisterAccountService
  - application.port.out
    - LoadAccountPort
    - UpdateAccountStatePort
    - CreateAccountPort
  - **adapter.out.persistence**
    - AccountPersistenceAdapter
    - UserPersistenceAdapter

### e.g  sendmoneyë¥¼ ìœ„í•œ.. load account ë¡œì§

ğŸ‘‰**application.service.SendMoneyService**

```java
public class SendMoneyService implements SendMoneyUseCase {
    private final LoadAccountPort loadAccountPort;
	
    @Override
	public boolean sendMoney(SendMoneyCommand command) {
        Account sourceAccount = loadAccountPort.loadAccount(
            command.getSourceAccountId(),
            baselineDate);
    }
}

```

ğŸ‘‰**application.port.out.LoadAccountPort**

```java
public interface LoadAccountPort {
	Account loadAccount(AccountId accountId, LocalDateTime baselineDate);
}
```

ğŸ‘‰**application.adapter.out.persistence.AccountPersistenceAdapter** ì˜ì†ì„± ì–´ëŒ‘í„°

```java
class AccountPersistenceAdapter implements
		LoadAccountPort {
	private final SpringDataAccountRepository accountRepository;
    private final AccountMapper accountMapper;
    
    @Override
	public Account loadAccount(
					AccountId accountId,
					LocalDateTime baselineDate) {

		AccountJpaEntity account =
				accountRepository.findById(accountId.getValue())
						.orElseThrow(EntityNotFoundException::new);

		List<ActivityJpaEntity> activities =
				activityRepository.findByOwnerSince(
						accountId.getValue(),
						baselineDate);

		Long withdrawalBalance = orZero(activityRepository
				.getWithdrawalBalanceUntil(
						accountId.getValue(),
						baselineDate));

		Long depositBalance = orZero(activityRepository
				.getDepositBalanceUntil(
						accountId.getValue(),
						baselineDate));

		return accountMapper.mapToDomainEntity(
				account,
				activities,
				withdrawalBalance,
				depositBalance);
	}
}
```



### ë°”ìš´ë””ë“œ ì»¨í…ìŠ¤íŠ¸

- ì˜ì†ì„± ì–´ëŒ‘í„°ë¥¼ í•˜ë‚˜ì”© ê°€ì§€ê³  ìˆìŒ
- ë°”ìš´ë””ë“œ ì»¨í…ìŠ¤íŠ¸ -> ê²½ê³„ë¥¼ ì•”ì‹œ
- account ë§¥ë½ì˜ ì„œë¹„ìŠ¤ê°€ billing ë§¥ë½ì˜ ì˜ì†ì„± ì–´ëŒ‘í„°ì— ì ‘ê·¼í•˜ì§€ ì•ŠìŒ
- ì–´ë–¤ ë§¥ë½ì´ ë‹¤ë¥¸ ë§¥ë½ì— ìˆëŠ” ë¬´ì—‡ì¸ê°€ë¥¼ í•„ìš”ë¡œ í•œë‹¤ë©´ **ì „ìš© ì¸ì»¤ë° í¬íŠ¸ë¥¼ ì´ìš©í•´ ì ‘ê·¼í•´ì•¼ í•¨**



## JPA ì˜ˆì œ



### ì—”í‹°í‹° ìƒì„± í´ë˜ìŠ¤?

```java
@AllArgsConstructor(access = AccessLevel.PRIVATE)
public class Account {
	@Getter private final AccountId id;
    @Getter private final ActivityWindow activityWindow;
    private final Money baselineBalance;
    
    public static Account withoutId(
   			Money baselineBalance,
    		ActivityWindow activityWindow) {
        return new Account(null, baselineBalance, activityWindow);
    }
    
    public static Account withId(AccountId accountId, Money baselineBalacne, ActivityWindow activityWindow) {
        return new Account(accountId, baselineBalance, activityWindow);
    }
    
    public Money calculateBalance() {
        // ...
    }
    
    public boolean withdraw(Money money, AccountId targetAccountId) {
        // ...
    }
    
    public boolean deposit(Money money, AccountId sourceAccountId)

}

```

- ìµœëŒ€í•œ ë¶ˆë³€ì„±ì„ ìœ ì§€
- ìœ íš¨í•œ ìƒíƒœì˜ Account ì—”í‹°í‹°ë§Œ ìƒì„±í•  ìˆ˜ ìˆëŠ” íŒ©í„°ë¦¬ ë©”ì„œë“œ ì œê³µ
  - +ìœ íš¨ì„± ê²€ì¦



### ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœë¥¼ í‘œí˜„í•˜ëŠ” @Entity í´ë˜ìŠ¤

```java
@Entity
@Table(name = "account")
@Data
@AllArgsConstructor
@NoArgsConstructor
class AccountJpaEntity {
    @Id
    @GeneratedValue
    private Long id;
}
```

```java
@Entity
@Table(name = "activity")
@Data
@AllArgsConstructor
@NoArgsConstructor
class AccountJpaEntity {
    @Id
    @GeneratedValue
    private Long id;
    
    @Column private LocalDateTime timestamp;
    @Column private Long ownerAccountId;
    @COlumn private Long sourceAccountId;
    @Column private Long targetAccountId;
    @Column private Long amount;
}
```



### Repository

ìƒëµ..



### ì˜ì†ì„± ì–´ëŒ‘í„°

```java
@RequiredArgsConstructor
@Component
class AccountPersistenceAdapter implements
    LoadAccountPort,
UpdateAccountStatePort {
    private final AccountRepository accountRepository;
    private final ActivityRepository activityRepository;
    private final AccountMapper accountMapper;
    
    @Override
    public Account loadAccount(AccountId accountId, LocalDateTime baselineDate) {
        AccountJpaEntity account = accountRepository.findById(accountId.getValue())
            .orElseThrow(EntityNotFoundException::new);
        
        List<ActivityJpaEntity> activities = activityRepository.findBYOwnerSince(accountId.getValue(), baselineDate);
        
        Long withdrawalBalance = orZero(activityRepository.getWithdrawalBalanceUntil(accountId.getVlaue(), baselineDate));
        
        Long depositBalance = orZero(activityRepository.getDepositoBalanceUntil(accountId.getVlaue(), baselineDate));
        
        return accountMapper.mapToDomainEntity(
        account,
        activities,
        withdrawalBalance,
        depositBalance);
    }
    
    private Long orZero(Long value) {
        return value == null ? 0L : value;
    }
    
    @Override
    public void updateActivities(Account account) {
        for (Activity activity : account.getActivityWindow().getActivities()) {
            if (activity.getId() == null) {
                activityRepository.save(accountMapper.mapToJpaEntity(activity));
            }
        }
    }
}
```

- ì• í”Œë¦¬ì¼€ì´ì…˜ì— í•„ìš”í•œ `LoadAccountPort`, `UpdateAccountStateStatePort` í¬íŠ¸ êµ¬í˜„

- DBë¡œë¶€í„° ê³„ì¢Œë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ `AccountRepository` ë¡œ ê³„ì¢Œë¥¼ ë¶ˆëŸ¬ì˜´

```java
AccountJpaEntity account = accountRepository.findById(accountId.getValue())
.orElseThrow(EntityNotFoundException::new);
```

- `ActivityRepository` ë¡œ í•´ë‹¹ ê³„ì¢Œì˜ íŠ¹ì • ì‹œê°„ ë²”ìœ„ ë™ì•ˆì˜ í™œë™ì„ ê°€ì ¸ì˜´

```java
List<ActivityJpaEntity> activities = activityRepository.findBYOwnerSince(accountId.getValue(), baselineDate);
```

- Account ë„ë©”ì¸ ì—”í‹°í‹°ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ì„œëŠ”
  - í™œë™ ì‹œì‘ ì§ì „ì˜ ê³„ì¢Œ ì”ê³ ê°€ í•„ìš”
  - ê·¸ë˜ì•¼ ëª¨ë“  ì¶œê¸ˆê³¼ ì…ê¸ˆ ì •ë³´ë¥¼ ê°€ì ¸ì™€ í•©í•  ìˆ˜ ìˆìŒ
  - ì´ ëª¨ë“  ë°ì´í„°ë¥¼ Account ë„ë©”ì¸ ì—”í‹°í‹°ì— ë§¤í•‘, í˜¸ì¶œìì—ê²Œ ë°˜í™˜

```java
// ì¶œê¸ˆ ì •ë³´
Long withdrawalBalance = orZero(activityRepository.getWithdrawalBalanceUntil(accountId.getVlaue(), baselineDate));

//ì…ê¸ˆ ì •ë³´
Long depositBalance = orZero(activityRepository.getDepositoBalanceUntil(accountId.getVlaue(), baselineDate));
```

- ê³„ì¢Œì˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ê¸° ìœ„í•´ì„œëŠ”
  - Account ì—”í‹°í‹°ì˜ ëª¨ë“  í™œë™ã…‡ì„ ìˆœíšŒí•˜ë©° IDê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì•¼ í•¨
  - IDê°€ ì—†ë‹¤ë©´ ActivityRepositoryë¥¼ ì´ìš©í•´ ì €ì¥í•´ì•¼í•¨....

```java
    @Override
    public void updateActivities(Account account) {
        for (Activity activity : account.getActivityWindow().getActivities()) {
            if (activity.getId() == null) {
                activityRepository.save(accountMapper.mapToJpaEntity(activity));
            }
        }
    }
```

- ì˜ì†ì„± ì¸¡ë©´ê³¼ì˜ íƒ€í˜‘ ì—†ì´ í’ë¶€í•œ ë„ë©”ì¸ ëª¨ë¸ì„ ìƒì„±í•˜ê³  ì‹¶ë‹¤ë©´ ë„ë©”ì¸ ëª¨ë¸ê³¼ ì˜ì†ì„± ëª¨ë¸ì„ ë§¤í•‘í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
